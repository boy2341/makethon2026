<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Referral â€” Jeevan-Setu</title>
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    .lang-toggle {
      display: flex;
      align-items: center;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 100px;
      padding: 3px;
      gap: 2px;
    }

    .lang-btn {
      padding: 3px 10px;
      border: none;
      border-radius: 100px;
      background: transparent;
      font-family: var(--mono);
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.06em;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s;
    }

    .lang-btn.active {
      background: var(--white);
      color: var(--ink);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- Header -->
    <div class="hd">
      <div class="hd-top">
        <span class="wordmark">Jeevan-Setu</span>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="lang-toggle">
            <button class="lang-btn active" id="btnEn" onclick="setLang('en')">EN</button>
            <button class="lang-btn" id="btnHi" onclick="setLang('hi')">à¤¹à¤¿</button>
          </div>
          <div id="apiStatus"><span class="dot"></span><span id="apiTxt">connecting</span></div>
        </div>
      </div>
      <h1 data-en="Patient Referral" data-hi="à¤°à¥‹à¤—à¥€ à¤°à¥‡à¤«à¤°à¤²">Patient Referral</h1>
      <p class="sub" data-en="Submit details to receive AI-matched hospital recommendations."
        data-hi="AI-à¤®à¤¿à¤²à¤¾à¤¨ à¤…à¤¸à¥à¤ªà¤¤à¤¾à¤² à¤¸à¤¿à¤«à¤¾à¤°à¤¿à¤¶à¥‡à¤‚ à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤µà¤¿à¤µà¤°à¤£ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚à¥¤">
        Submit details to receive AI-matched hospital recommendations.
      </p>
    </div>

    <div class="prog-track">
      <div class="prog-fill" id="prog"></div>
    </div>

    <form id="form" novalidate>

      <!-- Personal -->
      <div class="card">
        <div class="card-head">
          <span>ğŸ‘¤</span>
          <span class="card-head-label" data-en="Personal" data-hi="à¤µà¥à¤¯à¤•à¥à¤¤à¤¿à¤—à¤¤">Personal</span>
        </div>
        <div class="card-body">
          <div class="field">
            <label data-en="Full Name" data-hi="à¤ªà¥‚à¤°à¤¾ à¤¨à¤¾à¤®">Full Name <span class="req">*</span></label>
            <input type="text" id="name" data-ph-en="Patient full name" data-ph-hi="à¤°à¥‹à¤—à¥€ à¤•à¤¾ à¤ªà¥‚à¤°à¤¾ à¤¨à¤¾à¤®"
              placeholder="Patient full name" autocomplete="off">
          </div>
          <div class="row-2">
            <div class="field">
              <label data-en="Age" data-hi="à¤†à¤¯à¥">Age <span class="req">*</span></label>
              <input type="number" id="age" data-ph-en="Years" data-ph-hi="à¤µà¤°à¥à¤·" placeholder="Years" min="1" max="120">
            </div>
            <div class="field">
              <label data-en="Current Hospital" data-hi="à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤…à¤¸à¥à¤ªà¤¤à¤¾à¤²">Current Hospital <span
                  class="req">*</span></label>
              <input type="text" id="hospital" data-ph-en="Hospital name" data-ph-hi="à¤…à¤¸à¥à¤ªà¤¤à¤¾à¤² à¤•à¤¾ à¤¨à¤¾à¤®"
                placeholder="Hospital name">
            </div>
          </div>
          <div class="field">
            <label data-en="Gender" data-hi="à¤²à¤¿à¤‚à¤—">Gender <span class="req">*</span></label>
            <div class="toggles" id="genderGroup">
              <button type="button" class="tog" data-val="male" data-en="Male" data-hi="à¤ªà¥à¤°à¥à¤·">Male</button>
              <button type="button" class="tog" data-val="female" data-en="Female" data-hi="à¤®à¤¹à¤¿à¤²à¤¾">Female</button>
              <button type="button" class="tog" data-val="other" data-en="Other" data-hi="à¤…à¤¨à¥à¤¯">Other</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Medical -->
      <div class="card">
        <div class="card-head">
          <span>ğŸ©º</span>
          <span class="card-head-label" data-en="Medical" data-hi="à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾">Medical</span>
        </div>
        <div class="card-body">
          <div class="field">
            <label data-en="Referral Condition" data-hi="à¤°à¥‡à¤«à¤°à¤² à¤¸à¥à¤¥à¤¿à¤¤à¤¿">Referral Condition <span
                class="req">*</span></label>
            <select id="disease">
              <option value="" data-en="Select conditionâ€¦" data-hi="à¤¸à¥à¤¥à¤¿à¤¤à¤¿ à¤šà¥à¤¨à¥‡à¤‚â€¦">Select conditionâ€¦</option>
              <option value="cardiology" data-en="Cardiology" data-hi="à¤¹à¥ƒà¤¦à¤¯ à¤°à¥‹à¤—">Cardiology</option>
              <option value="neurology" data-en="Neurology" data-hi="à¤¤à¤‚à¤¤à¥à¤°à¤¿à¤•à¤¾ à¤µà¤¿à¤œà¥à¤à¤¾à¤¨">Neurology</option>
              <option value="oncology" data-en="Oncology" data-hi="à¤•à¥ˆà¤‚à¤¸à¤° à¤µà¤¿à¤œà¥à¤à¤¾à¤¨">Oncology</option>
              <option value="orthopedics" data-en="Orthopedics" data-hi="à¤¹à¤¡à¥à¤¡à¥€ à¤°à¥‹à¤—">Orthopedics</option>
              <option value="gastroenterology" data-en="Gastroenterology" data-hi="à¤ªà¤¾à¤šà¤¨ à¤°à¥‹à¤—">Gastroenterology</option>
              <option value="pulmonology" data-en="Pulmonology" data-hi="à¤«à¥‡à¤«à¤¡à¤¼à¥‡ à¤°à¥‹à¤—">Pulmonology</option>
              <option value="nephrology" data-en="Nephrology" data-hi="à¤—à¥à¤°à¥à¤¦à¤¾ à¤°à¥‹à¤—">Nephrology</option>
              <option value="endocrinology" data-en="Endocrinology" data-hi="à¤…à¤‚à¤¤à¤ƒà¤¸à¥à¤°à¤¾à¤µ à¤µà¤¿à¤œà¥à¤à¤¾à¤¨">Endocrinology</option>
              <option value="psychiatry" data-en="Psychiatry" data-hi="à¤®à¤¨à¥‹à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾">Psychiatry</option>
              <option value="pediatrics" data-en="Pediatrics" data-hi="à¤¬à¤¾à¤² à¤°à¥‹à¤—">Pediatrics</option>
              <option value="gynecology" data-en="Gynecology" data-hi="à¤¸à¥à¤¤à¥à¤°à¥€ à¤°à¥‹à¤—">Gynecology</option>
              <option value="dermatology" data-en="Dermatology" data-hi="à¤¤à¥à¤µà¤šà¤¾ à¤°à¥‹à¤—">Dermatology</option>
              <option value="ophthalmology" data-en="Ophthalmology" data-hi="à¤¨à¥‡à¤¤à¥à¤° à¤°à¥‹à¤—">Ophthalmology</option>
              <option value="other" data-en="Other" data-hi="à¤…à¤¨à¥à¤¯">Other</option>
            </select>
          </div>
          <div class="field" id="otherField" style="display:none;">
            <label data-en="Specify Condition" data-hi="à¤¸à¥à¤¥à¤¿à¤¤à¤¿ à¤¬à¤¤à¤¾à¤à¤‚">Specify Condition <span
                class="req">*</span></label>
            <input type="text" id="otherDisease" data-ph-en="Describe the conditionâ€¦" data-ph-hi="à¤¸à¥à¤¥à¤¿à¤¤à¤¿ à¤•à¤¾ à¤µà¤°à¥à¤£à¤¨ à¤•à¤°à¥‡à¤‚â€¦"
              placeholder="Describe the conditionâ€¦">
          </div>
        </div>
      </div>

      <!-- Location -->
      <div class="card">
        <div class="card-head">
          <span>ğŸ“</span>
          <span class="card-head-label" data-en="Location" data-hi="à¤¸à¥à¤¥à¤¾à¤¨">Location</span>
        </div>
        <div class="card-body">
          <div class="field">
            <label data-en="GPS" data-hi="GPS">GPS</label>
            <button type="button" class="geo-btn" id="geoBtn" onclick="getGeo()">
              <span id="geoIcon">â—</span>
              <span id="geoTxt" data-en="Detect my location" data-hi="à¤®à¥‡à¤°à¤¾ à¤¸à¥à¤¥à¤¾à¤¨ à¤ªà¤¹à¤šà¤¾à¤¨à¥‡à¤‚">Detect my location</span>
            </button>
            <div class="geo-coords" id="geoResult"></div>
          </div>
          <div class="field">
            <label data-en="Address (optional)" data-hi="à¤ªà¤¤à¤¾ (à¤µà¥ˆà¤•à¤²à¥à¤ªà¤¿à¤•)">Address (optional)</label>
            <input type="text" id="address" data-ph-en="Area or address" data-ph-hi="à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤¯à¤¾ à¤ªà¤¤à¤¾"
              placeholder="Area or address">
          </div>
        </div>
      </div>

      <!-- Status -->
      <div class="card">
        <div class="card-head">
          <span>ğŸ“‹</span>
          <span class="card-head-label" data-en="Status" data-hi="à¤¸à¥à¤¥à¤¿à¤¤à¤¿">Status</span>
        </div>
        <div class="card-body">
          <div class="row-2">
            <div class="field">
              <label data-en="Income Level" data-hi="à¤†à¤¯ à¤¸à¥à¤¤à¤°">Income Level <span class="req">*</span></label>
              <div class="toggles" id="bplGroup">
                <button type="button" class="tog" data-val="below" data-en="Below BPL" data-hi="BPL à¤¸à¥‡ à¤¨à¥€à¤šà¥‡">Below
                  BPL</button>
                <button type="button" class="tog" data-val="above" data-en="Above BPL" data-hi="BPL à¤¸à¥‡ à¤Šà¤ªà¤°">Above
                  BPL</button>
              </div>
            </div>
            <div class="field">
              <label data-en="Disability" data-hi="à¤µà¤¿à¤•à¤²à¤¾à¤‚à¤—à¤¤à¤¾">Disability <span class="req">*</span></label>
              <div class="toggles" id="disabledGroup">
                <button type="button" class="tog" data-val="yes" data-en="Disabled" data-hi="à¤µà¤¿à¤•à¤²à¤¾à¤‚à¤—">Disabled</button>
                <button type="button" class="tog" data-val="no" data-en="Not Disabled" data-hi="à¤µà¤¿à¤•à¤²à¤¾à¤‚à¤— à¤¨à¤¹à¥€à¤‚">Not
                  Disabled</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn" data-en="Submit Referral" data-hi="à¤°à¥‡à¤«à¤°à¤² à¤œà¤®à¤¾ à¤•à¤°à¥‡à¤‚">Submit
        Referral</button>
    </form>

    <div class="err-banner" id="errBanner"></div>

  </div>
  <script>
    const API = 'http://localhost:8000'; // Change this to your actual API endpoint
    const sel = {};
    let gps = null;
    let currentLang = 'en';

    // â”€â”€ Translation strings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const T = {
      en: {
        connecting: 'connecting',
        online: 'online',
        offline: 'offline',
        locating: 'Locatingâ€¦',
        locCaptured: 'Location captured',
        locDenied: 'Permission denied',
        locUnavail: 'Unavailable',
        locTimeout: 'Timeout',
        locFailed: 'Failed',
        locNoSupport: 'Not supported',
        submitting: 'Submittingâ€¦',
        submitBtn: 'Submit Referral',
        errRequired: 'Please complete all required fields.',
        errApi: 'Could not reach API.',
        pageTitle: 'Patient Referral',
      },
      hi: {
        connecting: 'à¤œà¥‹à¤¡à¤¼ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚',
        online: 'à¤‘à¤¨à¤²à¤¾à¤‡à¤¨',
        offline: 'à¤‘à¤«à¤²à¤¾à¤‡à¤¨',
        locating: 'à¤–à¥‹à¤œ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚â€¦',
        locCaptured: 'à¤¸à¥à¤¥à¤¾à¤¨ à¤®à¤¿à¤²à¤¾',
        locDenied: 'à¤…à¤¨à¥à¤®à¤¤à¤¿ à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¥€',
        locUnavail: 'à¤…à¤¨à¥à¤ªà¤²à¤¬à¥à¤§',
        locTimeout: 'à¤¸à¤®à¤¯ à¤¸à¤®à¤¾à¤ªà¥à¤¤',
        locFailed: 'à¤µà¤¿à¤«à¤²',
        locNoSupport: 'à¤¸à¤®à¤°à¥à¤¥à¤¿à¤¤ à¤¨à¤¹à¥€à¤‚',
        submitting: 'à¤œà¤®à¤¾ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆâ€¦',
        submitBtn: 'à¤°à¥‡à¤«à¤°à¤² à¤œà¤®à¤¾ à¤•à¤°à¥‡à¤‚',
        errRequired: 'à¤•à¥ƒà¤ªà¤¯à¤¾ à¤¸à¤­à¥€ à¤†à¤µà¤¶à¥à¤¯à¤• à¤«à¤¼à¥€à¤²à¥à¤¡ à¤­à¤°à¥‡à¤‚à¥¤',
        errApi: 'API à¤¤à¤• à¤¨à¤¹à¥€à¤‚ à¤ªà¤¹à¥à¤à¤šà¤¾ à¤œà¤¾ à¤¸à¤•à¤¾à¥¤',
        pageTitle: 'à¤°à¥‹à¤—à¥€ à¤°à¥‡à¤«à¤°à¤²',
      }
    };

    // â”€â”€ Apply language â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setLang(lang) {
      currentLang = lang;
      document.getElementById('btnEn').classList.toggle('active', lang === 'en');
      document.getElementById('btnHi').classList.toggle('active', lang === 'hi');

      // Update all data-en / data-hi elements
      document.querySelectorAll('[data-en]').forEach(el => {
        if (el.tagName === 'LABEL') {
          // Preserve the <span class="req">*</span> inside label
          const req = el.querySelector('.req');
          el.childNodes[0].textContent = el.dataset[lang] + ' ';
        } else if (el.tagName === 'OPTION') {
          el.textContent = el.dataset[lang];
        } else {
          el.textContent = el.dataset[lang];
        }
      });

      // Update placeholders
      document.querySelectorAll('[data-ph-en]').forEach(el => {
        el.placeholder = lang === 'en' ? el.dataset.phEn : el.dataset.phHi;
      });

      // Page title
      document.title = T[lang].pageTitle + ' â€” Jeevan-Setu';

      // API status pill text
      const pill = document.getElementById('apiStatus');
      const apiTxt = document.getElementById('apiTxt');
      if (pill.classList.contains('on')) apiTxt.textContent = T[lang].online;
      else if (pill.classList.contains('off')) apiTxt.textContent = T[lang].offline;
      else apiTxt.textContent = T[lang].connecting;

      // Geo button text (only if not mid-locating)
      const geoTxt = document.getElementById('geoTxt');
      if (gps) {
        geoTxt.textContent = T[lang].locCaptured;
      } else if (!geoTxt.textContent.includes('â€¦')) {
        geoTxt.textContent = geoTxt.dataset[lang];
      }

      // Submit button (if not mid-submit)
      const submitBtn = document.getElementById('submitBtn');
      if (!submitBtn.disabled) submitBtn.textContent = T[lang].submitBtn;
    }

    // â”€â”€ API health ping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function ping() {
      const pill = document.getElementById('apiStatus');
      const txt = document.getElementById('apiTxt');
      try {
        const r = await fetch(`${API}/health`, { signal: AbortSignal.timeout(3000) });
        if (r.ok) { pill.className = 'on'; txt.textContent = T[currentLang].online; }
        else throw 0;
      } catch { pill.className = 'off'; txt.textContent = T[currentLang].offline; }
    }
    ping(); setInterval(ping, 20000);

    // â”€â”€ Toggle chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll('.toggles').forEach(grp => {
      grp.querySelectorAll('.tog').forEach(btn => {
        btn.onclick = () => {
          grp.querySelectorAll('.tog').forEach(b => b.classList.remove('sel'));
          btn.classList.add('sel');
          sel[grp.id] = btn.dataset.val;
          updateProgress();
        };
      });
    });

    // â”€â”€ Other disease field â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('disease').onchange = function () {
      document.getElementById('otherField').style.display = this.value === 'other' ? 'block' : 'none';
      updateProgress();
    };

    // â”€â”€ Progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const RF = ['name', 'age', 'hospital', 'disease'];
    const RG = ['genderGroup', 'bplGroup', 'disabledGroup'];
    function updateProgress() {
      let n = 0;
      RF.forEach(id => { if (document.getElementById(id)?.value.trim()) n++; });
      RG.forEach(id => { if (sel[id]) n++; });
      document.getElementById('prog').style.width = (n / (RF.length + RG.length) * 100) + '%';
    }
    RF.forEach(id => document.getElementById(id)?.addEventListener('input', updateProgress));

    // â”€â”€ Geolocation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getGeo() {
      const btn = document.getElementById('geoBtn');
      const icon = document.getElementById('geoIcon');
      const txt = document.getElementById('geoTxt');
      if (!navigator.geolocation) { txt.textContent = T[currentLang].locNoSupport; return; }
      btn.className = 'geo-btn';
      icon.textContent = 'â€¦';
      txt.textContent = T[currentLang].locating;
      navigator.geolocation.getCurrentPosition(
        p => {
          gps = { lat: p.coords.latitude, lng: p.coords.longitude };
          btn.className = 'geo-btn ok';
          icon.textContent = 'âœ“';
          txt.textContent = T[currentLang].locCaptured;
          const box = document.getElementById('geoResult');
          box.textContent = `${gps.lat.toFixed(5)}, ${gps.lng.toFixed(5)}`;
          box.classList.add('show');
        },
        e => {
          btn.className = 'geo-btn fail';
          icon.textContent = 'âœ•';
          const msgs = ['', T[currentLang].locDenied, T[currentLang].locUnavail, T[currentLang].locTimeout];
          txt.textContent = msgs[e.code] || T[currentLang].locFailed;
        },
        { timeout: 10000, enableHighAccuracy: true }
      );
    }

    // â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('form').onsubmit = async function (e) {
      e.preventDefault();
      hideErr();

      const name = document.getElementById('name').value.trim();
      const age = parseInt(document.getElementById('age').value);
      const hospital = document.getElementById('hospital').value.trim();
      const disease = document.getElementById('disease').value;

      if (!name || !age || !hospital || !disease || !sel.genderGroup || !sel.bplGroup || !sel.disabledGroup) {
        showErr(T[currentLang].errRequired); return;
      }

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = T[currentLang].submitting;

      try {
        const res = await fetch(`${API}/api/referral`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name, age,
            gender: sel.genderGroup,
            hospital,
            disease,
            otherDisease: disease === 'other' ? document.getElementById('otherDisease').value.trim() : null,
            bplStatus: sel.bplGroup,
            disabled: sel.disabledGroup,
            location: gps,
            address: document.getElementById('address').value.trim(),
            timestamp: new Date().toISOString()
          })
        });

        const data = await res.json();
        if (!res.ok) {
          const msg = Array.isArray(data.detail) ? data.detail[0] : (data.detail || 'Error');
          throw new Error(msg);
        }

        sessionStorage.setItem('referralResult', JSON.stringify(data));
        window.location.href = 'result.html';

      } catch (err) {
        showErr(err.message || T[currentLang].errApi);
      } finally {
        btn.disabled = false;
        btn.textContent = T[currentLang].submitBtn;
      }
    };

    function showErr(msg) {
      const b = document.getElementById('errBanner');
      b.textContent = 'âœ• ' + msg;
      b.className = 'err-banner show';
      b.scrollIntoView({ behavior: 'smooth' });
    }

    function hideErr() {
      document.getElementById('errBanner').className = 'err-banner';
    }
  </script>
</body>

</html>
