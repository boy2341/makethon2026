<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Referral Result ‚Äî Jeevan-Setu</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f7f6f3;
    --white: #ffffff;
    --ink: #111318;
    --muted: #8a8f9a;
    --border: #e2e0da;
    --accent: #1a56db;
    --accent-pale: #eef3fe;
    --green: #0d7a4e;
    --green-pale: #ebfaf3;
    --red: #c0392b;
    --red-pale: #fdf0ee;
    --amber: #b45309;
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'IBM Plex Sans', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--ink);
    font-size: 14px;
    line-height: 1.6;
    min-height: 100vh;
    padding: 48px 16px 80px;
  }

  .wrap { max-width: 560px; margin: 0 auto; }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .hd { margin-bottom: 28px; }

  .hd-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  .wordmark {
    font-family: var(--mono);
    font-size: 11px; font-weight: 600;
    letter-spacing: 0.14em; text-transform: uppercase;
    color: var(--muted);
  }

  .back-btn {
    display: inline-flex; align-items: center; gap: 6px;
    font-family: var(--mono); font-size: 10px; font-weight: 600;
    letter-spacing: 0.08em; text-transform: uppercase;
    color: var(--muted); text-decoration: none;
    padding: 4px 10px; border: 1px solid var(--border);
    border-radius: 100px; background: var(--white);
    transition: all 0.15s;
  }
  .back-btn:hover { border-color: var(--accent); color: var(--accent); }

  h1 { font-size: 22px; font-weight: 600; letter-spacing: -0.02em; line-height: 1.2; margin-bottom: 4px; }
  .sub { font-size: 13px; color: var(--muted); }

  /* ‚îÄ‚îÄ Result card ‚îÄ‚îÄ */
  .result { border-radius: 12px; overflow: hidden; border: 1px solid #6ee7b7; background: var(--white); }

  .result-head {
    padding: 14px 20px;
    font-family: var(--mono); font-size: 11px; font-weight: 600; letter-spacing: 0.06em;
    border-bottom: 1px solid #6ee7b7;
    display: flex; align-items: center; justify-content: space-between; gap: 10px;
    color: var(--green); background: var(--green-pale);
  }

  .ref-id {
    font-family: var(--mono); font-size: 12px; font-weight: 600;
    color: var(--accent); background: var(--accent-pale);
    padding: 4px 10px; border-radius: 6px;
    cursor: pointer; user-select: all; letter-spacing: 0.04em;
  }

  /* Summary grid */
  .summary { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); border-bottom: 1px solid var(--border); }
  .summary-cell { background: var(--white); padding: 12px 16px; }
  .summary-cell .k { font-family: var(--mono); font-size: 9px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 3px; }
  .summary-cell .v { font-size: 13px; font-weight: 500; }

  .priority-HIGH   { color: var(--red); }
  .priority-MEDIUM { color: var(--amber); }
  .priority-NORMAL { color: var(--green); }

  /* Sections */
  .res-section { border-top: 1px solid var(--border); padding: 16px 20px; }

  .res-section-label {
    font-family: var(--mono); font-size: 9px; font-weight: 600;
    letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 10px;
  }

  /* AI explanation */
  .ai-text {
    font-size: 13px; line-height: 1.7; color: #374151;
    background: var(--accent-pale); border-left: 3px solid var(--accent);
    padding: 10px 14px; border-radius: 0 8px 8px 0;
  }

  /* Hospital cards */
  .hosp-card { display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .hosp-card:last-child { border-bottom: none; padding-bottom: 0; }
  .hosp-rank { font-family: var(--mono); font-size: 11px; color: var(--muted); min-width: 18px; padding-top: 2px; }
  .hosp-info { flex: 1; }
  .hosp-name { font-size: 13px; font-weight: 600; color: var(--ink); margin-bottom: 2px; }
  .hosp-meta { font-size: 12px; color: var(--muted); display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 4px; }
  .hosp-spec { display: inline-block; font-size: 11px; color: var(--accent); background: var(--accent-pale); padding: 2px 7px; border-radius: 4px; }
  .hosp-rating { font-family: var(--mono); font-size: 12px; font-weight: 600; color: var(--green); white-space: nowrap; padding-top: 2px; }

  /* OSM rows */
  .osm-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .osm-row:last-child { border-bottom: none; padding-bottom: 0; }
  .osm-name { font-size: 13px; font-weight: 500; color: var(--ink); }
  .osm-addr { font-size: 11px; color: var(--muted); margin-top: 1px; }
  .osm-dist { font-family: var(--mono); font-size: 11px; color: var(--muted); white-space: nowrap; }
  .badge-em { display: inline-block; font-size: 9px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: var(--red); background: var(--red-pale); padding: 1px 5px; border-radius: 3px; margin-left: 5px; }

  /* Schemes */
  .schemes { display: flex; flex-wrap: wrap; gap: 5px; }
  .scheme-tag { font-family: var(--mono); font-size: 10px; font-weight: 500; padding: 3px 8px; border-radius: 4px; background: var(--accent-pale); color: var(--accent); letter-spacing: 0.04em; }

  /* No data fallback */
  .no-data {
    text-align: center; padding: 60px 20px;
    color: var(--muted); font-size: 14px;
  }
  .no-data a {
    color: var(--accent); text-decoration: none; font-weight: 600;
  }
  .no-data a:hover { text-decoration: underline; }

  /* New referral button */
  .new-btn {
    display: block; width: 100%; margin-top: 14px; padding: 13px;
    background: var(--white); color: var(--accent);
    border: 1.5px solid var(--accent); border-radius: 10px;
    font-family: var(--sans); font-size: 14px; font-weight: 600;
    cursor: pointer; text-align: center; text-decoration: none;
    transition: background 0.15s;
  }
  .new-btn:hover { background: var(--accent-pale); }
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="hd">
    <div class="hd-top">
      <span class="wordmark">Jeevan-Setu</span>
      <a class="back-btn" href="index.html">‚Üê New Referral</a>
    </div>
    <h1>Referral Result</h1>
    <p class="sub">AI-matched hospital recommendations for your patient.</p>
  </div>

  <div id="content"></div>

</div>
<script>
  function x(s) {
    return String(s).replace(/[&<>"']/g, c =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
    );
  }

  function copyId(id) {
    navigator.clipboard?.writeText(id);
    const el = document.getElementById('refIdSpan');
    const old = el.textContent;
    el.textContent = 'copied!';
    setTimeout(() => el.textContent = old, 1200);
  }

  function render(d) {
    const container = document.getElementById('content');

    // AI section
    const aiHTML = d.ai_explanation ? `
      <div class="res-section">
        <div class="res-section-label">AI Recommendation</div>
        <div class="ai-text">${x(d.ai_explanation)}</div>
      </div>` : '';

    // Recommended hospitals
    const hospHTML = d.recommended_hospitals?.length ? `
      <div class="res-section">
        <div class="res-section-label">Recommended Hospitals</div>
        ${d.recommended_hospitals.map((h, i) => `
          <div class="hosp-card">
            <div class="hosp-rank">${i + 1}.</div>
            <div class="hosp-info">
              <div class="hosp-name">${x(h.id)}</div>
              <div class="hosp-meta">
                <span>${x(h.city)}, ${x(h.state)}</span>
                <span>üõè ${h.beds} beds</span>
                ${h.distance_km != null ? `<span>üìè ${h.distance_km} km</span>` : ''}
              </div>
              <span class="hosp-spec">${x(h.specialisation)}</span>
            </div>
            <div class="hosp-rating">‚òÖ ${h.rating}</div>
          </div>
        `).join('')}
      </div>` : '';

    // OSM nearby hospitals
    const osmHTML = d.nearby_osm_hospitals?.length ? `
      <div class="res-section">
        <div class="res-section-label">Nearby Hospitals ‚Äî Live Map</div>
        ${d.nearby_osm_hospitals.map(h => `
          <div class="osm-row">
            <div>
              <div class="osm-name">${x(h.name)}${h.emergency === 'yes' ? '<span class="badge-em">Emergency</span>' : ''}</div>
              ${h.address ? `<div class="osm-addr">${x(h.address)}</div>` : ''}
              ${h.phone   ? `<div class="osm-addr">${x(h.phone)}</div>` : ''}
            </div>
            <div class="osm-dist">${h.distance_km != null ? h.distance_km + ' km' : ''}</div>
          </div>
        `).join('')}
      </div>` : '';

    // Schemes
    const schemesHTML = d.schemes_eligible?.length ? `
      <div class="res-section">
        <div class="res-section-label">Eligible Schemes</div>
        <div class="schemes">
          ${d.schemes_eligible.map(s => `<span class="scheme-tag">${x(s)}</span>`).join('')}
        </div>
      </div>` : '';

    container.innerHTML = `
      <div class="result">
        <div class="result-head">
          <span>‚úì Referral submitted</span>
          <span class="ref-id" id="refIdSpan" onclick="copyId('${x(d.referral_id)}')">${x(d.referral_id)}</span>
        </div>

        <div class="summary">
          <div class="summary-cell"><div class="k">Patient</div><div class="v">${x(d.patient_name)}</div></div>
          <div class="summary-cell"><div class="k">Condition</div><div class="v">${x(d.disease_label)}</div></div>
          <div class="summary-cell"><div class="k">Priority</div><div class="v priority-${x(d.priority)}">${x(d.priority)}</div></div>
          <div class="summary-cell"><div class="k">Received</div><div class="v">${new Date(d.received_at).toLocaleTimeString()}</div></div>
        </div>

        ${aiHTML}
        ${hospHTML}
        ${osmHTML}
        ${schemesHTML}
      </div>

      <a class="new-btn" href="index.html">+ Submit Another Referral</a>
    `;
  }

  // Load data from sessionStorage
  const raw = sessionStorage.getItem('referralResult');
  if (raw) {
    try {
      render(JSON.parse(raw));
      sessionStorage.removeItem('referralResult'); // clean up after rendering
    } catch {
      document.getElementById('content').innerHTML = `
        <div class="no-data">Failed to parse result data. <a href="index.html">Go back</a></div>`;
    }
  } else {
    document.getElementById('content').innerHTML = `
      <div class="no-data">
        No referral data found.<br><br>
        <a href="index.html">‚Üê Submit a new referral</a>
      </div>`;
  }
</script>
</body>
</html>
