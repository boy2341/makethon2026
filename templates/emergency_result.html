<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nearest Hospitals ‚Äî Jeevan-Setu</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap"
      rel="stylesheet"
    />
    <style>
      /* ‚îÄ‚îÄ Reset & Base ‚îÄ‚îÄ */
      *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

      :root {
        --bg: #f9f8f5;
        --white: #ffffff;
        --ink: #111318;
        --muted: #6b7280;
        --border: #e5e3dc;
        --accent: #c0392b;
        --accent-pale: #fdf0ee;
        --green: #0d7a4e;
        --green-pale: #ebfaf3;
        --gold: #c8941a;
        --card-shadow: 0 1px 3px rgba(0,0,0,0.07), 0 4px 16px rgba(0,0,0,0.05);
        --serif: 'Instrument Serif', serif;
        --sans: 'DM Sans', sans-serif;
      }

      body {
        font-family: var(--sans);
        background: var(--bg);
        color: var(--ink);
        font-size: 14px;
        line-height: 1.6;
        min-height: 100vh;
      }

      /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
      .topbar {
        position: sticky; top: 0; z-index: 100;
        display: flex; align-items: center; justify-content: space-between;
        padding: 14px 28px;
        background: rgba(255,255,255,0.92);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
      }

      .brand {
        font-family: var(--serif);
        font-size: 20px; color: var(--ink); letter-spacing: -0.01em;
      }
      .brand em { color: var(--accent); font-style: italic; }

      #locBadge {
        display: flex; align-items: center; gap: 7px;
        font-size: 12px; color: var(--muted);
        background: var(--bg); border: 1px solid var(--border);
        padding: 5px 12px; border-radius: 100px;
        max-width: 260px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
      }

      .loc-pulse {
        width: 8px; height: 8px; border-radius: 50%;
        background: var(--green); flex-shrink: 0;
        animation: pulse 1.4s ease-in-out infinite;
      }
      .loc-pulse.loading { background: #f59e0b; }
      .loc-pulse.error   { background: var(--accent); animation: none; }

      @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50%       { opacity: 0.5; transform: scale(0.85); }
      }

      /* ‚îÄ‚îÄ Page layout ‚îÄ‚îÄ */
      .page {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 28px;
        max-width: 1200px;
        margin: 0 auto;
        padding: 36px 28px 60px;
      }

      @media (max-width: 860px) {
        .page { grid-template-columns: 1fr; }
        .right { order: -1; }
      }

      /* ‚îÄ‚îÄ Left section ‚îÄ‚îÄ */
      .section-eyebrow {
        font-size: 11px; font-weight: 600; letter-spacing: 0.1em;
        text-transform: uppercase; color: var(--accent);
        margin-bottom: 8px;
      }

      .section-title {
        font-family: var(--serif);
        font-size: clamp(32px, 5vw, 48px);
        line-height: 1.1; letter-spacing: -0.02em;
        margin-bottom: 10px;
      }
      .section-title em { color: var(--accent); font-style: italic; }

      .section-sub { font-size: 13px; color: var(--muted); margin-bottom: 28px; }

      /* ‚îÄ‚îÄ Source toggle ‚îÄ‚îÄ */
      .source-tabs {
        display: flex; gap: 6px; margin-bottom: 20px; flex-wrap: wrap;
      }

      .src-tab {
        padding: 6px 14px; border-radius: 100px;
        border: 1px solid var(--border); background: var(--white);
        font-size: 12px; font-weight: 500; color: var(--muted);
        cursor: pointer; transition: all 0.15s;
      }
      .src-tab:hover { border-color: var(--accent); color: var(--ink); }
      .src-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

      /* ‚îÄ‚îÄ Hospital grid ‚îÄ‚îÄ */
      .hospital-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 14px;
      }

      /* ‚îÄ‚îÄ Skeleton ‚îÄ‚îÄ */
      .skeleton-card {
        background: var(--white);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 18px;
        display: flex; flex-direction: column; gap: 10px;
        min-height: 180px;
      }

      .skeleton {
        background: linear-gradient(90deg, #ece9e0 25%, #f5f3ee 50%, #ece9e0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.4s infinite;
        border-radius: 4px;
      }

      @keyframes shimmer {
        0%   { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }

      /* ‚îÄ‚îÄ Hospital card ‚îÄ‚îÄ */
      .hcard {
        background: var(--white);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 18px;
        display: flex; flex-direction: column; gap: 8px;
        box-shadow: var(--card-shadow);
        transition: transform 0.15s, box-shadow 0.15s;
        position: relative;
      }

      .hcard:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      }

      .hcard-rank {
        font-size: 10px; font-weight: 700; letter-spacing: 0.06em;
        text-transform: uppercase; color: var(--muted);
      }
      .hcard-rank.top {
        color: var(--gold);
        background: #fef9e7; padding: 2px 8px;
        border-radius: 100px; display: inline-block;
      }

      .hcard-name {
        font-size: 15px; font-weight: 600;
        color: var(--ink); line-height: 1.3;
      }

      .hcard-location {
        display: flex; align-items: center; gap: 4px;
        font-size: 12px; color: var(--muted);
      }

      .hcard-divider {
        height: 1px; background: var(--border); margin: 4px 0;
      }

      .hcard-stats {
        display: flex; gap: 16px;
      }

      .hstat {
        display: flex; flex-direction: column; gap: 1px;
      }

      .hstat-val { font-size: 13px; font-weight: 600; color: var(--ink); }
      .hstat-lbl { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }

      .hcard-tags {
        display: flex; flex-wrap: wrap; gap: 4px; margin-top: 2px;
      }

      .htag {
        font-size: 10px; font-weight: 500;
        padding: 2px 7px; border-radius: 4px;
        background: #f3f4f6; color: var(--muted);
        letter-spacing: 0.03em;
      }

      .htag-spec {
        background: #eef3fe; color: #1a56db;
      }

      .htag-em {
        background: var(--accent-pale); color: var(--accent);
        font-weight: 700;
      }

      .htag-source-db  { background: #f0fdf4; color: var(--green); }
      .htag-source-osm { background: #fffbeb; color: #92400e; }

      .hcard-dist {
        display: flex; align-items: center; gap: 4px;
        font-size: 12px; color: var(--muted); margin-top: 4px;
      }

      .hcard-directions {
        display: block; width: 100%; margin-top: 6px;
        padding: 8px; border-radius: 8px;
        background: var(--bg); border: 1px solid var(--border);
        font-size: 12px; font-weight: 600; color: var(--ink);
        text-align: center; text-decoration: none;
        transition: background 0.15s;
      }
      .hcard-directions:hover { background: var(--border); }

      /* ‚îÄ‚îÄ State boxes ‚îÄ‚îÄ */
      .state-box {
        grid-column: 1 / -1;
        background: var(--white); border: 1px solid var(--border);
        border-radius: 14px; padding: 40px 24px;
        text-align: center;
      }
      .state-box .icon { font-size: 32px; margin-bottom: 10px; }
      .state-box h3 { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
      .state-box p { font-size: 13px; color: var(--muted); max-width: 300px; margin: 0 auto; }

      /* ‚îÄ‚îÄ Right panel ‚îÄ‚îÄ */
      .right {
        display: flex; flex-direction: column; gap: 16px;
      }

      .panel-label {
        font-size: 10px; font-weight: 700; letter-spacing: 0.1em;
        text-transform: uppercase; color: var(--muted); margin-bottom: 12px;
      }

      /* ‚îÄ‚îÄ Emergency hero ‚îÄ‚îÄ */
      .emergency-hero {
        background: linear-gradient(135deg, #c0392b, #96281b);
        border-radius: 14px; padding: 22px 20px;
        text-align: center; color: #fff;
        display: flex; flex-direction: column; align-items: center; gap: 4px;
      }

      .ambulance-icon { font-size: 32px; margin-bottom: 6px; }
      .emergency-label { font-size: 11px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; opacity: 0.8; }
      .emergency-number { font-size: 52px; font-weight: 700; line-height: 1; letter-spacing: -0.03em; }
      .emergency-sub { font-size: 12px; opacity: 0.75; margin-bottom: 8px; }

      .call-btn {
        display: inline-block;
        padding: 10px 24px; border-radius: 100px;
        background: #fff; color: var(--accent);
        font-size: 13px; font-weight: 700;
        text-decoration: none; letter-spacing: 0.02em;
        transition: transform 0.1s;
      }
      .call-btn:hover { transform: scale(1.03); }

      /* ‚îÄ‚îÄ Helplines ‚îÄ‚îÄ */
      .helplines {
        background: var(--white); border: 1px solid var(--border);
        border-radius: 14px; overflow: hidden;
      }

      .helpline-item {
        display: flex; align-items: center; justify-content: space-between;
        padding: 11px 16px; border-bottom: 1px solid var(--border);
        gap: 10px;
      }
      .helpline-item:last-child { border-bottom: none; }

      .hl-left { display: flex; flex-direction: column; gap: 1px; }
      .hl-name { font-size: 13px; font-weight: 600; color: var(--ink); }
      .hl-desc { font-size: 11px; color: var(--muted); }

      .hl-num {
        font-size: 15px; font-weight: 700; color: var(--accent);
        text-decoration: none; letter-spacing: 0.02em;
        padding: 4px 10px; border-radius: 8px;
        background: var(--accent-pale);
        transition: background 0.15s;
      }
      .hl-num:hover { background: #fad7d3; }

      /* ‚îÄ‚îÄ Tip box ‚îÄ‚îÄ */
      .tip-box {
        background: #fffbeb; border: 1px solid #fde68a;
        border-radius: 12px; padding: 14px 16px;
        font-size: 12px; line-height: 1.6; color: #78350f;
      }
      .tip-box strong { display: block; margin-bottom: 4px; }

      /* ‚îÄ‚îÄ API status bar ‚îÄ‚îÄ */
      .api-status-bar {
        display: none;
        margin-bottom: 16px; padding: 10px 14px;
        border-radius: 8px; font-size: 12px; font-weight: 500;
        align-items: center; gap: 8px;
      }
      .api-status-bar.err  { display: flex; background: var(--accent-pale); color: var(--accent); border: 1px solid #fca5a5; }
      .api-status-bar.warn { display: flex; background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }
      .api-status-bar.info { display: flex; background: var(--green-pale); color: var(--green); border: 1px solid #6ee7b7; }
    </style>
  </head>
  <body>

    <!-- Top bar -->
    <div class="topbar">
      <div class="brand">Jeevan-<em>Setu</em></div>
      <div id="locBadge">
        <span class="loc-pulse loading" id="locDot"></span>
        <span id="locText">Detecting location‚Ä¶</span>
      </div>
    </div>

    <!-- Page -->
    <div class="page">

      <!-- LEFT: Hospital grid -->
      <div class="left">
        <div class="section-eyebrow">Emergency ¬∑ Based on your location</div>
        <h1 class="section-title">Nearest<br /><em>Hospitals</em></h1>
        <p class="section-sub" id="sectionSub">Searching for hospitals near you‚Ä¶</p>

        <!-- API status bar -->
        <div class="api-status-bar" id="apiStatusBar"></div>

        <!-- Source filter tabs -->
        <div class="source-tabs" id="sourceTabs" style="display:none;">
          <button class="src-tab active" data-src="all"    onclick="filterSource('all')">All</button>
          <button class="src-tab"        data-src="database" onclick="filterSource('database')">üìã Our Database</button>
          <button class="src-tab"        data-src="osm"    onclick="filterSource('osm')">üó∫ Live Map</button>
        </div>

        <div class="hospital-grid" id="hospitalGrid">
          <!-- Skeletons while loading -->
          <div class="skeleton-card">
            <div class="skeleton" style="height:12px;width:40%;border-radius:6px"></div>
            <div class="skeleton" style="height:18px;width:80%;border-radius:6px"></div>
            <div class="skeleton" style="height:12px;width:55%;border-radius:6px"></div>
            <div style="flex:1"></div>
            <div class="skeleton" style="height:36px;border-radius:8px"></div>
          </div>
          <div class="skeleton-card">
            <div class="skeleton" style="height:12px;width:40%;border-radius:6px"></div>
            <div class="skeleton" style="height:18px;width:70%;border-radius:6px"></div>
            <div class="skeleton" style="height:12px;width:50%;border-radius:6px"></div>
            <div style="flex:1"></div>
            <div class="skeleton" style="height:36px;border-radius:8px"></div>
          </div>
          <div class="skeleton-card">
            <div class="skeleton" style="height:12px;width:35%;border-radius:6px"></div>
            <div class="skeleton" style="height:18px;width:75%;border-radius:6px"></div>
            <div class="skeleton" style="height:12px;width:60%;border-radius:6px"></div>
            <div style="flex:1"></div>
            <div class="skeleton" style="height:36px;border-radius:8px"></div>
          </div>
          <div class="skeleton-card">
            <div class="skeleton" style="height:12px;width:45%;border-radius:6px"></div>
            <div class="skeleton" style="height:18px;width:65%;border-radius:6px"></div>
            <div class="skeleton" style="height:12px;width:52%;border-radius:6px"></div>
            <div style="flex:1"></div>
            <div class="skeleton" style="height:36px;border-radius:8px"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Emergency panel -->
      <div class="right">
        <div>
          <div class="panel-label">Emergency Helplines</div>
          <div class="emergency-hero">
            <span class="ambulance-icon">üöë</span>
            <div class="emergency-label">National Ambulance</div>
            <div class="emergency-number">108</div>
            <div class="emergency-sub">Free ¬∑ 24 / 7 ¬∑ All India</div>
            <a class="call-btn" href="tel:108">Call 108 Now</a>
          </div>
        </div>

        <div class="helplines">
          <div class="helpline-item">
            <div class="hl-left"><span class="hl-name">Police</span><span class="hl-desc">Emergency response</span></div>
            <a class="hl-num" href="tel:100">100</a>
          </div>
          <div class="helpline-item">
            <div class="hl-left"><span class="hl-name">Fire Brigade</span><span class="hl-desc">Fire &amp; rescue</span></div>
            <a class="hl-num" href="tel:101">101</a>
          </div>
          <div class="helpline-item">
            <div class="hl-left"><span class="hl-name">PMSS Ambulance</span><span class="hl-desc">Andhra Pradesh</span></div>
            <a class="hl-num" href="tel:104">104</a>
          </div>
          <div class="helpline-item">
            <div class="hl-left"><span class="hl-name">National Emergency</span><span class="hl-desc">Unified helpline</span></div>
            <a class="hl-num" href="tel:112">112</a>
          </div>
          <div class="helpline-item">
            <div class="hl-left"><span class="hl-name">Women Helpline</span><span class="hl-desc">24 / 7 support</span></div>
            <a class="hl-num" href="tel:1091">1091</a>
          </div>
        </div>

        <div class="tip-box">
          <strong>üí° Quick tip</strong>
          When calling 108, stay on the line. Share your exact location, the
          patient's condition, and your phone number so the dispatcher can
          track and guide you.
        </div>
      </div>
    </div>

    <script>
      const API = 'http://localhost:8000';

      // All fetched hospitals stored here for filtering
      let allHospitals = [];
      let currentSource = 'all';

      // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      function renderStars(r) {
        let s = '';
        for (let i = 1; i <= 5; i++)
          s += `<span style="color:${i <= Math.round(r) ? '#c8941a' : '#ddd'};font-size:11px">‚òÖ</span>`;
        return s;
      }

      function mapsLink(name, lat, lon) {
        const q = encodeURIComponent(lat && lon ? `${lat},${lon}` : name);
        return `https://www.google.com/maps/search/?api=1&query=${q}`;
      }

      function renderCard(h, rank) {
        const isTop    = rank === 1;
        const isDB     = h.source === 'database';
        const sourceTag = isDB
          ? `<span class="htag htag-source-db">üìã Our DB</span>`
          : `<span class="htag htag-source-osm">üó∫ Live</span>`;

        const emergTag = h.emergency === 'yes'
          ? `<span class="htag htag-em">üö® Emergency</span>` : '';

        const schemes = isDB && h.schemes
          ? h.schemes.split(',').slice(0, 2).map(s =>
              `<span class="htag">${s.trim()}</span>`).join('')
          : '';

        const specTag = (h.specialisation || h.spec)
          ? `<span class="htag htag-spec">${h.specialisation || h.spec}</span>` : '';

        const bedsTag = h.beds
          ? `<div class="hstat"><span class="hstat-val">${h.beds}</span><span class="hstat-lbl">Beds</span></div>` : '';

        const ratingTag = h.rating
          ? `<div class="hstat"><span class="hstat-val">${h.rating} ${renderStars(h.rating)}</span><span class="hstat-lbl">Rating</span></div>` : '';

        const lat = h.coordinates?.lat ?? h.lat;
        const lon = h.coordinates?.lon ?? h.lon;
        const dist = h.distance_km != null
          ? `<div class="hcard-dist">
               <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2C8.1 2 5 5.1 5 9c0 5.2 7 13 7 13s7-7.8 7-13c0-3.9-3.1-7-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg>
               ${h.distance_km} km away
             </div>` : '';

        return `
          <div class="hcard" data-source="${h.source}">
            <div class="hcard-rank ${isTop ? 'top' : ''}">${isTop ? '‚≠ê Nearest' : '#' + rank}</div>
            <div class="hcard-name">${esc(h.name || h.id)}</div>
            <div class="hcard-location">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2C8.1 2 5 5.1 5 9c0 5.2 7 13 7 13s7-7.8 7-13c0-3.9-3.1-7-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg>
              ${esc(h.city || h.address || '‚Äî')}${h.state ? ', ' + esc(h.state) : ''}
            </div>
            <div class="hcard-divider"></div>
            <div class="hcard-stats">${ratingTag}${bedsTag}</div>
            <div class="hcard-tags">${sourceTag}${emergTag}${specTag}${schemes}</div>
            ${dist}
            <a class="hcard-directions" href="${mapsLink(h.name || h.id, lat, lon)}" target="_blank" rel="noopener">
              üó∫ Get Directions
            </a>
          </div>`;
      }

      function esc(s) {
        return String(s ?? '').replace(/[&<>"']/g, c =>
          ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])
        );
      }

      // ‚îÄ‚îÄ Filter by source tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      function filterSource(src) {
        currentSource = src;
        document.querySelectorAll('.src-tab').forEach(t => {
          t.classList.toggle('active', t.dataset.src === src);
        });

        const filtered = src === 'all'
          ? allHospitals
          : allHospitals.filter(h => h.source === src);

        if (!filtered.length) {
          document.getElementById('hospitalGrid').innerHTML = `
            <div class="state-box">
              <div class="icon">üîç</div>
              <h3>No results</h3>
              <p>No hospitals found for this filter. Try "All".</p>
            </div>`;
        } else {
          document.getElementById('hospitalGrid').innerHTML =
            filtered.map((h, i) => renderCard(h, i + 1)).join('');
        }
      }

      // ‚îÄ‚îÄ Status bar helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      function setStatus(type, msg) {
        const bar = document.getElementById('apiStatusBar');
        bar.className = `api-status-bar ${type}`;
        bar.textContent = msg;
      }

      // ‚îÄ‚îÄ Fetch from backend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      async function loadHospitals(lat, lon) {
        try {
          const res = await fetch(
            `${API}/api/hospitals/nearby?lat=${lat}&lon=${lon}&condition=&radius=50`,
            { signal: AbortSignal.timeout(10000) }
          );

          if (!res.ok) throw new Error(`Server returned ${res.status}`);

          const data = await res.json();

          // Merge database + OSM results, both already have distance_km
          const dbHospitals  = (data.database_hospitals || []).map(h => ({ ...h, source: 'database' }));
          const osmHospitals = (data.osm_hospitals || []).map(h => ({ ...h, source: 'osm' }));

          // Sort merged list by distance
          allHospitals = [...dbHospitals, ...osmHospitals]
            .filter(h => h.distance_km != null)
            .sort((a, b) => a.distance_km - b.distance_km);

          if (!allHospitals.length) {
            document.getElementById('hospitalGrid').innerHTML = `
              <div class="state-box">
                <div class="icon">üè•</div>
                <h3>No hospitals found</h3>
                <p>No hospitals found within 50 km of your location in our database.</p>
              </div>`;
            document.getElementById('sectionSub').textContent = 'No results near you.';
            return;
          }

          const total = allHospitals.length;
          const dbCount  = dbHospitals.length;
          const osmCount = osmHospitals.length;

          document.getElementById('sectionSub').textContent =
            `Showing ${total} hospitals near you ‚Äî ${dbCount} from our database, ${osmCount} from live map`;

          setStatus('info', `‚úì Loaded ${total} hospitals (${dbCount} from our database ¬∑ ${osmCount} from OpenStreetMap)`);

          // Show tabs only if both sources have results
          if (dbCount > 0 && osmCount > 0) {
            document.getElementById('sourceTabs').style.display = 'flex';
          }

          filterSource('all');

        } catch (err) {
          console.error('API error:', err);

          // Show offline message + fallback notice
          setStatus('err', `‚ö† Could not reach backend (${err.message}). Make sure "node index.js" is running.`);

          document.getElementById('hospitalGrid').innerHTML = `
            <div class="state-box">
              <div class="icon">üîå</div>
              <h3>Backend offline</h3>
              <p>Start your server with <strong>node index.js</strong> and refresh this page.</p>
            </div>`;
          document.getElementById('sectionSub').textContent = 'Could not load hospital data.';
        }
      }

      // ‚îÄ‚îÄ Geolocation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      const locDot  = document.getElementById('locDot');
      const locText = document.getElementById('locText');

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const { latitude: lat, longitude: lng } = pos.coords;
            locDot.classList.remove('loading');
            locText.textContent = `${lat.toFixed(4)}¬∞N, ${lng.toFixed(4)}¬∞E`;
            loadHospitals(lat, lng);
          },
          err => {
            locDot.classList.remove('loading');
            locDot.classList.add('error');
            locText.textContent = 'Location denied';

            // Fallback: Anantpur, Andhra Pradesh
            const FALLBACK_LAT = 14.693, FALLBACK_LON = 77.6;
            setStatus('warn', '‚ö† Location access denied ‚Äî showing hospitals near Anantpur (default fallback).');
            document.getElementById('sectionSub').textContent =
              'Showing hospitals near Anantpur (location access denied)';
            loadHospitals(FALLBACK_LAT, FALLBACK_LON);
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      } else {
        locDot.classList.add('error');
        locText.textContent = 'Not supported';
        loadHospitals(14.693, 77.6);
      }
    </script>
  </body>
</html>
